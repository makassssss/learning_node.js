<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css"
          integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">

    <title>departments & employees</title>

    <style type="text/css">
        .not-unique {
            display: none;
            color: red;
        }

        .success-add, .success-edit {
            display: none;
            color: green;
        }
    </style>

</head>
<body>

<h3 class="my-4 title" style="text-align: center">
    <% if (!!id) { %>
        Edit department
    <% } else { %>
        Add new department
    <% } %>
</h3>

<form id="form" class="mx-auto" style="width: 40%">
    <input type="hidden" class="form-control" id="id" name="id" value="<%= id %>"/>
    <div class="form-group">
        <label for="name">department name *</label>
        <span class="validation not-unique pl-4">Value must be unique</span>
        <input type="text" class="form-control" id="name" name="name" value="<%= name %>" required/>
    </div>
    <div>
        <input
                type="submit"
                class="btn btn-secondary float-right"
                style="width: 200px"
                value=<% if (!!id) { %>
                    'Edit'
        <% } else { %>
            'Add'
        <% } %>
        />
        <a href="/" class="btn btn-secondary"><</a>
        <span class="validation success-add pl-4">New department was added</span>
        <spann class="validation success-edit pl-4">The department was edited</spann>
    </div>
</form>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous">
</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js"
        integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4"
        crossorigin="anonymous">
</script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
<script>

	$(document).ready(function() {
		var handleFormSubmit = function() {
			$('.validation').css('display', 'none');
			$('#form').validate({
				rules: {
					name: "required",
				},
				errorPlacement: function(error, element) {
					error.insertBefore(element);
					error.css('color', 'red');
					error.css('padding-left', '1rem');
				},
				submitHandler: function(form, e) {
					e.preventDefault();
					var data = {
						id: form.id.value,
						department_name: form.name.value,
					};
					$.ajax({
						url: '/setDepartment',
						type: 'post',
						data: JSON.stringify(data),
						success: function() {
							if (form.id.value) {
								$('.success-edit').css('display', 'inline-block');
							} else {
								$('.success-add').css('display', 'inline-block');
							}
						},
						error: function(res) {
							if (res.responseText === 'Value is not unique') {
								$('.not-unique').css('display', 'inline-block');
							}
						}
					})
				},
			})
		}

		$('input[type=submit]').click(function() {
			handleFormSubmit();
		});
	});

</script>
</body>
</html>
