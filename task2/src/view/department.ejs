<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css"
          integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">

    <title>departments & employees</title>

    <style type="text/css">
        .invalid, .not-unique {
            display: none;
            color: red;
        }

        .success-add, .success-edit {
            display: none;
            color: green;
        }
    </style>

</head>
<body>

<h3 class="my-4 title" style="text-align: center">
    <% if (!!id) { %>
    Edit department
    <% } else { %>
    Add new department
    <% } %>
</h3>

<form class="mx-auto" style="width: 40%">
    <input type="hidden" class="form-control" id="id" name="id"  value="<%= id %>" />
    <div class="form-group">
        <label for="name">department name *</label>
        <span class="validation invalid pl-4">This field is required</span>
        <span class="validation not-unique pl-4">Value must be unique</span>
        <input type="text" class="form-control" id="name" name="name"  value="<%= name %>" required/>
    </div>
    <div>
        <input  onclick="handleForm(event, this.form)"
                type="submit"
                class="btn btn-secondary float-right"
                style="width: 200px"
                value=<% if (!!id) { %>
                'Edit'
        <% } else { %>
        'Add'
        <% } %>
        />
        <a href="/" class="btn btn-secondary"><</a>
        <span class="validation success-add pl-4">New department was added</span>
        <spann class="validation success-edit pl-4">The department was edited</spann>
    </div>
</form>

<script>

    window.onload = function() {
        return document.querySelector('#id').value;
    };

    const id = window.onload();

    function handleForm(e, form) {
        e.preventDefault();
        const xhr = new XMLHttpRequest();
        const nameField = form.elements.name;
        document.querySelectorAll('.validation').forEach((i) => i.style.display = 'none');
        if (nameField.value.length === 0) {
            document.querySelector('.invalid').style.display = 'inline-block';
        } else {
            document.querySelector('.invalid').style.display = 'none';
            if (id === '') {
                xhr.open('POST', '/addDepartment', true);
                xhr.send(JSON.stringify({department_name: nameField.value }));
            } else {
                xhr.open('POST', '/editDepartment', true);
                xhr.send(JSON.stringify({id: id, department_name: nameField.value}));
            }

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.responseText === 'Value is not unique') {
                        document.querySelector('.not-unique').style.display = 'inline-block';
                    } else {
                        document.querySelector('.not-unique').style.display = 'none';
                        const title = document.querySelector('.title').innerText;
                        if (title === 'Add new department') {
                            document.querySelector('.success-add').style.display = 'inline-block';
                        } else {
                            document.querySelector('.success-edit').style.display = 'inline-block';
                        }
                    }
                }
            }
        }
    }

</script>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous">
</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js"
        integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4"
        crossorigin="anonymous">
</script>
</body>
</html>
